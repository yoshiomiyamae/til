x86 Assembler
===
基本的にはアセンブラがよしなにしてくれるが、中身を知らないまま書くのは気持ちが悪いので勉強する。

## レジスタ
### 汎用レジスタ
| 31 --- 16 | 15 --- 8 | 7 --- 0 | 16bit | 32bit | 説明 |
|---|:-:|:-:|:-:|:-:|---|
| | ah | al | ax | eax | アキュムレータレジスタ。算術演算操作の結果が格納される。 |
| | bh | bl | bx | ebx | ベースレジスタ。セグメントモードでのｄｓに格納されたデータのポインタ。 |
| | ch | cl | cx | ecx | カウンタレジスタ。シフトローテート命令とループ命令に使用される。 |
| | dh | dl | dx | edx | データレジスタ。算術演算操作とI/O操作に使用される。 |
| | | | bp | ebp | スタックベースポインタレジスタ。スタックのベースのポインタ。 |
| | | | si | esi | ソースレジスタ。ストリーム操作でのソースへのポインタ。 |
| | | | di | edi | デスティネーションレジスタ。ストリーム操作でのデスティネーションへのポインタ。 |
| | | | sp | esp | スタックポインターレジスタ。スタックのトップのポインタ。 |

### EFLAGSレジスタ
| 31 | 30 | 29 | 28 | 27 | 26 | 25 | 24 | 23 | 22 | 21 | 20 | 19 | 18 | 17 | 16 |
|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|
| 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | IDフラグ(ID) | 仮想割込保留フラグ(VIP) | 仮想割込フラグ(VIF) | アライメントチェックフラグ(AC) | 仮想8086モード(VM) | 再開フラグ(RF) |

| 15 | 14 | 13 | 12 | 11 | 10 | 9 | 8 | 7 | 6 | 5 | 4 | 3 | 2 | 1 | 0 |
|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|
| 0 | ネストタスクフラグ(NT) | I/O特権レベルフィールド(IOPL) || オーバーフローフラグ(OF) | 方向フラグ(DF) | 割込有効フラグ(IF) | トラップフラグ(TF) | 符号フラグ(SF) | ゼロフラグ(ZF) | 0 | 調整フラグ(AF) | 0 | パリティフラグ(PF) | 0 | キャリーフラグ(CF) |

| フラグ名 | 種類 | 説明 |
|---|---|---|
| IDフラグ(ID) | システムフラグ |  |
| 仮想割込保留フラグ(VIP) | システムフラグ |  |
| 仮想割込フラグ(VIF) | システムフラグ |  |
| アライメントチェックフラグ(AC) | システムフラグ |  |
| 仮想8086モード(VM) | システムフラグ |  |
| 再開フラグ(RF) | システムフラグ |  |
| ネストタスクフラグ(NT) | システムフラグ |  |
| I/O特権レベルフィールド(IOPL) | システムフラグ |  |
| オーバーフローフラグ(OF) | 状態フラグ |  |
| 方向フラグ(DF) | 操作フラグ |  |
| 割込有効フラグ(IF) | システムフラグ |  |
| トラップフラグ(TF) | システムフラグ |  |
| 符号フラグ(SF) | 状態フラグ |  |
| ゼロフラグ(ZF) | 状態フラグ |  |
| 調整フラグ(AF) | 状態フラグ |  |
| パリティフラグ(PF) | 状態フラグ |  |
| キャリーフラグ(CF) | 状態フラグ |  |

### セグメントレジスタ
| 名前 | 説明|
|:-:|---|
| cs | コードセグメント |
| ss | スタックセグメント |
| ds | データセグメント |
| es | エクストラデータセグメント |
| fs |  |
| gs |  |

## オペランド
### 命令欄
| オペランド | 説明 |
|---|---|
| `rel8` | 命令の終りの前の128bytesから命令の終りの後の127bytesまでの範囲の相対アドレス。 |
| `rel16`| アセンブル結果の命令と同じコード・セグメント内の相対アドレス。<br/>オペランド・サイズ属性が16bitsである命令に適用される。 |
| `rel32`| アセンブル結果の命令と同じコード・セグメント内の相対アドレス。<br/>オペランド・サイズ属性が32bitsである命令に適用される。 |
| `ptr16:16`| 一般的に命令のコード・セグメントとは異なるコード・セグメント内のfarポインタ。<br/>16:16という表記法は、ポインタの値が2つの部分からなっていることを示す。<br/>コロンの左側の値は、16bitsのセレクタ、すなわちコード・セグメント・レジスタに送られる値である。<br/>右側の値はデスティネーション・セグメント内のオフセットに対応する。<br/>命令のオペランド・サイズ属性が16bitsである場合に使用される。 |
| `ptr16:32`| 一般的に命令のコード・セグメントとは異なるコード・セグメント内のfarポインタ。<br/>16:32という表記法は、ポインタの値が2つの部分からなっていることを示す。<br/>コロンの左側の値は、16bitsのセレクタ、すなわちコード・セグメント・レジスタに送られる値である。<br/>右側の値はデスティネーション・セグメント内のオフセットに対応する。<br/>命令のオペランド・サイズ属性が32bitsである場合に使用される。 |
| `r8` | 汎用バイトレジスタ`al` `ah` `bl` `bh` `cl` `ch` `dl` `dh`のいずれか。  |
| `r16` | 汎用ワードレジスタ`ax` `bx` `cx` `dx` `bp` `si` `di` `sp`のいずれか。  |
| `r32` | 汎用ダブルワードレジスタ`eax` `ebx` `ecx` `edx` `ebp` `esi` `edi` `esp`のいずれか。  |
| `imm8` | 即値バイト値。記号imm8は-128から+127までの符号付き数値である。<br/>imm8がワードまたはダブルワードのオペランドと結合される命令については、即値は符号拡張されてワードまたはダブルワードを構成する。その場合は、ワードの上位バイトは即値の最上位ビットで埋められる。 |
| `imm16` | オペランド・サイズ属性が16bitsである命令に使用される即値ダブルワード値。<br/>これには-32,768から+32,767までの数値を使用できる。 |
| `imm32` | オペランド・サイズ属性が32ビットである命令に使用される即値ダブルワード値。<br/>これには-2,147,483,648から+2,147,483,647までの数値を使用できる。 |
| `m8` | 通常、変数名または配列名として表されるが、ds:(e)siまたはes:(e)diレジスタによってアドレス指定されるバイト・メモリ・オペランド。<br/>これはストリング命令およびxlat命令に対してのみ使用される。 |
| `m16` | 通常、変数名または配列名として表されるが、ds:(e)siまたはes:(e)diレジスタによってアドレス指定されるワード・メモリ・オペランド。<br/>これはストリング命令に対してのみ使用される。 |
| `m32` | 通常、変数名または配列名として表されるが、ds:(e)siまたはes:(e)diレジスタによってアドレス指定されるダブルワード・メモリ・オペランド。<br/>これはストリング命令に対してのみ使用される。 |
| `m64` | 通常、変数名または配列名として表されるが、ds:(e)siまたはes:(e)diレジスタによってアドレス指定されるクワッドワード・メモリ・オペランド。<br/>これはcmpxchg8b命令に対してのみ使用される。 |
| `m128` | 通常、変数名または配列名として表されるが、ds:(e)siまたはes:(e)diレジスタによってアドレス指定されるダブル・クワッドワード・メモリ・オペランド。<br/>これはSSE, SSE2, SSE3に対してのみ使用される。 |
| `r/m8` | r8かm8のいずれか。 |
| `r/m16` | r16かm16のいずれか。 |
| `r/m32` | r32かm32のいずれか。 |
| `m16:16` | 2つの数値からなるfarポインタを内容とするメモリ・オペランド。<br/>コロンの左側の数値はポインタのセグメント・セレクタに対応し、右側の数値はポインタのオフセットに対応する。 |
| `m16:32` | 2つの数値からなるfarポインタを内容とするメモリ・オペランド。<br/>コロンの左側の数値はポインタのセグメント・セレクタに対応し、右側の数値はポインタのオフセットに対応する。 |
| `m16&16` | サイズがアンパーサンド記号の左側と右側に示されるデータ項目の対からなるメモリ・オペランド。<br/>すべてのメモリアドレス指定モードが可能である。<br/>bound命令で使用され、配列インデックスの上限および下限を内容とするオペランドを提供する。 |
| `m16&32` | サイズがアンパーサンド記号の左側と右側に示されるデータ項目の対からなるメモリ・オペランド。<br/>すべてのメモリアドレス指定モードが可能である。<br/>lidtおよびlgdtで使用され、対応するgdtrおよびidtrレジスタのlimitフィールドにロードするワード、およびベース・フィールドにロードするダブルワードを提供する。 |
| `m32&32` | サイズがアンパーサンド記号の左側と右側に示されるデータ項目の対からなるメモリ・オペランド。<br/>すべてのメモリアドレス指定モードが可能である。<br/>bound命令で使用され、配列インデックスの上限および下限を内容とするオペランドを提供する。 |
| `moffs8` | mov命令の一部のバリエーションによって使用されるバイト、ワード、またはダブルワード型のシンプルメモリ変数（メモリ・オフセット）。<br/>実際のアドレスは、セグメント・ベースからのシンプル・オフセットによって与えられる。<br/>命令にはModR/Mバイトは使用されない。<br/>8はセグメントのサイズであり、これは命令のアドレスサイズ属性によって決まる。 |
| `moffs16` | mov命令の一部のバリエーションによって使用されるバイト、ワード、またはダブルワード型のシンプルメモリ変数（メモリ・オフセット）。<br/>実際のアドレスは、セグメント・ベースからのシンプル・オフセットによって与えられる。<br/>命令にはModR/Mバイトは使用されない。<br/>16はセグメントのサイズであり、これは命令のアドレスサイズ属性によって決まる。 |
| `moffs32` | mov命令の一部のバリエーションによって使用されるバイト、ワード、またはダブルワード型のシンプルメモリ変数（メモリ・オフセット）。<br/>実際のアドレスは、セグメント・ベースからのシンプル・オフセットによって与えられる。<br/>命令にはModR/Mバイトは使用されない。<br/>32はセグメントのサイズであり、これは命令のアドレスサイズ属性によって決まる。 |
| `sreg` | セグメント・レジスタ。セグメント・レジスタのビット割り当ては、`es=0` `cs=1` `ss=2` `ds=3` `fs=4` `gs=5` |
| `m32fp` | 単精度浮動小数点数のメモリ・オペランド。x87 FPU浮動小数点命令のオペランドとして使用される浮動小数点の値が指定される。 |
| `m64fp` | 倍精度浮動小数点数のメモリ・オペランド。x87 FPU浮動小数点命令のオペランドとして使用される浮動小数点の値が指定される。 |
| `m80fp` | 拡張倍精度浮動小数点数のメモリ・オペランド。x87 FPU浮動小数点命令のオペランドとして使用される浮動小数点の値が指定される。 |
| `m16int` | ワード整数のメモリ・オペランド。x87 FPU整数命令のオペランドとして使用される整数が指定される。 |
| `m32int` | ダブルワード整数のメモリ・オペランド。x87 FPU整数命令のオペランドとして使用される整数が指定される。 |
| `m64int` | クワッドワード整数のメモリ・オペランド。x87 FPU整数命令のオペランドとして使用される整数が指定される。 |
| `st` or `st(0)` | FPUレジスタスタックの一番上の要素 |
| `st(i)` | FPUレジスタスタックの一番上からi番目の要素 (i←0〜7) |
| `mm` | MMX®テクノロジ・レジスタ。64-bit MMXテクノロジ・レジスタmm0からmm7まで。 |
| `mm/m32` | MMXテクノロジ・レジスタの下位32bitsまたは32bitsのメモリ・オペランド。<br/>64bitsのMMXテクノロジ・レジスタはmm0からmm7まで。<br/>メモリの内容は、実効アドレス計算によって与えられるアドレスにある。 |
| `mm/m64` | MMXテクノロジ・レジスタまたは64bitsのメモリ・オペランド。<br/>64bitsのMMXテクノロジ・レジスタはmm0からmm7まで。<br/>メモリの内容は、実効アドレス計算によって与えられるアドレスにある。 |
| `xmm` | XMMレジスタ。128bitsのXMMレジスタは、xmm0からxmm7まで。 |
| `xmm/m32` | XMMレジスタまたは32bitsのメモリ・オペランド。<br/>128bitsのMMXテクノロジ・レジスタはmm0からmm7まで。<br/>メモリの内容は、実効アドレス計算によって与えられるアドレスにある。 |
| `xmm/m64` | XMMレジスタまたは64bitsのメモリ・オペランド。<br/>128bitsのMMXテクノロジ・レジスタはmm0からmm7まで。<br/>メモリの内容は、実効アドレス計算によって与えられるアドレスにある。 |
| `xmm/m128` | XMMレジスタまたは128bitsのメモリ・オペランド。<br/>128bitsのMMXテクノロジ・レジスタはmm0からmm7まで。<br/>メモリの内容は、実効アドレス計算によって与えられるアドレスにある。 |

### オペコード欄
| オペランド | 説明 |
|---|---|
| `/digit` | `0`から`7`までの数字で、命令のModR/Mバイトがr/mオペランドだけを使用することを示す。regフィールドには、命令のオペコードを拡張する数字が入っている。 |
| `/r` | 命令のModR/Mバイトに、レジスタ・オペランドとr/オペランドの両方があることを示す。 |
| `cb` | オペコードの後に続く1byteの値であり、コード・オフセット、コード・セグメント・レジスタの新しい値を指定することができる。 |
| `cw` | オペコードの後に続く2bytesの値であり、コード・オフセット、コード・セグメント・レジスタの新しい値を指定することができる。 |
| `cd` | オペコードの後に続く4bytesの値であり、コード・オフセット、コード・セグメント・レジスタの新しい値を指定することができる。 |
| `cp` | オペコードの後に続く6bytesの値であり、コード・オフセット、コード・セグメント・レジスタの新しい値を指定することができる。 |
| `ib` | オペコード、ModM/Rバイト、またはスケール・インデクッス・バイトの後に続く命令への1byteの即値オペランドである。オペランドが符号付きかどうかは、オペコードによって決まる。すべてのワードおよびダブルワードが下位バイトから先に示される。 |
| `iw` | オペコード、ModM/Rバイト、またはスケール・インデクッス・バイトの後に続く命令への2bytesの即値オペランドである。オペランドが符号付きかどうかは、オペコードによって決まる。すべてのワードおよびダブルワードが下位バイトから先に示される。 |
| `id` | オペコード、ModM/Rバイト、またはスケール・インデクッス・バイトの後に続く命令への4byteの即値オペランドである。オペランドが符号付きかどうかは、オペコードによって決まる。すべてのワードおよびダブルワードが下位バイトから先に示される。 |
| `+rb` | 0から7までのレジスタコードであり、+符号の左側に現れる16進バイトに加算されて、単一のオペコード・バイトを構成する。 |

### 16bit
#### ModR/M
reg(register)とr/mの内容を示すための値

| 7 --- 6 | 5 --- 3 | 2 --- 0 |
|:-:|:-:|:-:|
| mode | register | r/m |

##### 組み合わせ
| r/m \\ mode | `00` | `01` | `10` | `11` |
|:-:|---|---|---|---|
| `000` | [bx + si] | [bx + si + disp8] | [bx + si + disp16] | al / ax |
| `001` | [bx + di] | [bx + di + disp8] | [bx + di + disp16] | cl / cx |
| `010` | [bp + si] | [bp + si + disp8] | [bp + si + disp16] | dl / dx |
| `011` | [bp + di] | [bp + di + disp8] | [bp + di + disp16] | bl / bx |
| `100` | [si] | [si + disp8] | [si + disp16] | ah / sp |
| `101` | [di] | [di + disp8] | [di + disp16] | ch / bp |
| `110` | [disp16]<sup>*注</sup> | [bp + disp8] | [bp + disp16] | dh / si |
| `111` | [bx] | [bx + disp8] | [bx + disp16] | bh / di |
\*注: `mode=00 r/m=110`には特別なルールがあるので、`[bp]`を実現したい時には、`mode=01 r/m=110 disp8=0`([bp + 0])と指定する必要がある。

詳細は以下の通り

##### mode
regとr/mの内容を指定する。

| mode (bin) | disp |
|:-:|---|
| `00` | レジスタ+レジスタ。(dispなし)但し、`r/m=110`の時、disp16 |
| `01` | レジスタ+disp8 |
| `10` | レジスタ+disp16 |
| `11` | レジスタ。`/digit`オペランドで使用される。 |

##### disp
diplacementの略。メモリのアドレス。

##### register

| レジスタ | register (bin) |
|:-:|:-:|
| `al` `ax` | `000` |
| `cl` `cx` | `001` |
| `dl` `dx` | `010` |
| `bl` `bx` | `011` |
| `ah` `sp` | `100` |
| `ch` `bp` | `101` |
| `dh` `si` | `110` |
| `bh` `di` | `111` |

##### r/m
register / memoryの略。

| r/m (bin) | オペランドアドレス |
|:-:|:-:|
| `000` | [bx + si + dispなし/8/16] |
| `001` | [bx + di + dispなし/8/16] |
| `010` | [bp + si + dispなし/8/16] |
| `011` | [bp + di + dispなし/8/16] |
| `100` | [si + dispなし/8/16] |
| `101` | [di + dispなし/8/16] |
| `110` | [bp + dispなし/8/16] 但し、`mode=0`の時、[disp16] |
| `111` | [bx + dispなし/8/16] |

#### オペコード
##### ジャンプ
| 命令 | オペコード | クロック数 | 説明 |
|---|:-:|:-:|---|
| `jmp rel8` | `EB cb` | 7+m | ショートジャンプ |
| `jmp rel16` | `E9 cw` | 7+m | ニアジャンプ |
| `jmp r/m16` | `FF /4` | 7+m/10+m | r/m |
| `jmp ptr16:16` | `EA cd` | 12+m, pm=27+m |  |
| `jmp ptr16:16` | `EA cd` | pm=45+m |  |
| `jmp ptr16:16` | `EA cd` | ts |  |
| `jmp ptr16:16` | `EA cd` | ts |  |
| `jmp m16:16` | `FF /5` | 43+m, pm=31+m |  |
| `jmp m16:16` | `FF /5` | pm=49+m |  |
| `jmp m16:16` | `FF /5` | 5+ts |  |
| `jmp m16:16` | `FF /5` | 5+ts |  |
| `jmp rel32` | `E9 cd` | 7+m | ニアジャンプ |
| `jmp r/m32` | `FF /4` | 7+m, 10+m |  |
| `jmp ptr16:32` | `EA cp` | 12+m, pm=27+m |  |
| `jmp ptr16:32` | `EA cp` | pm=45+m |  |
| `jmp ptr16:32` | `EA cp` | ts |  |
| `jmp ptr16:32` | `EA cp` | ts |  |
| `jmp m16:32` | `FF /5` | 43+m, pm=31m |  |
| `jmp m16:32` | `FF /5` | pm=49+m |  |
| `jmp m16:32` | `FF /5` | 5+ts |  |
| `jmp m16:32` | `FF /5` | 5+ts |  |

##### 文字列読み込み
| 命令 | オペコード | クロック数 | 説明 |
|---|:-:|:-:|---|
| `lods m8` | `AC` | 5 | byte ds:[(e)si]をalに読み込みます |
| `lods m16` | `AD` | 5 | word ds:[(e)si]をaxに読み込みます |
| `lods m32` | `AD` | 5 | dword ds:[(e)si]をeaxに読み込みます |
| `lodsb` | `AC` | 5 | byte ds:[(e)si]をalに読み込みます |
| `lodsw` | `AD` | 5 | word ds:[(e)si]をaxに読み込みます |
| `lodsd` | `AD` | 5 | dword ds:[(e)si]をeaxに読み込みます |
