FAT
===

FATはMicrosoftによって提唱されているファイルシステムで、**File Allocation Table** の略です。   
Webで調べた内容が仕様書通りで無い事が多いので、基本的に仕様書の翻訳をしていきます。   
仕様書の原文は[ここ](https://msdn.microsoft.com/en-us/windows/hardware/gg463080.aspx)からダウンロードできます。   

## FAT12 / FAT16
12とか16はFATのサイズです。

### ボリューム構造
| 種類 | 名称 | サイズ [sectors] | 開始アドレス [sector] | 説明 |
|---|---|:-:|:-:|---|
| 予約領域 | ブートセクタ | `1` | `0` | BPBなどのブート情報を含んだ領域です |
| FAT領域 | FAT | `BPB_FATSz16 * BPB_NumFATs` | `BPB_RsvdSecCnt` | FATです |
| ディレクトリ領域 | ルートディレクトリ | `(BPB_RootEntCnt * 0x20 + BPB_BytsPerSec - 1) / BPB_BytsPerSec` | `BPB_FATSz16 * BPB_NumFATs + BPB_RsvdSecCnt`   | ディレクトリ情報を格納します |
| データ領域 | クラスタ | `BPB_NumClus * BPB_SecPerClus` | `(BPB_RootEntCnt * 0x20 + BPB_BytsPerSec - 1) / BPB_BytsPerSec + BPB_FATSz16 * BPB_NumFATs + BPB_RsvdSecCnt` | ファイル情報を格納します |
| データ領域 | 未定義 | `BPB_TotSec - (BPB_RootEntCnt * 0x20 + BPB_BytsPerSec - 1) / BPB_BytsPerSec + BPB_FATSz16 * BPB_NumFATs + BPB_RsvdSecCnt` | `BPB_NumClus * BPB_SecPerClus + (BPB_RootEntCnt * 0x20 + BPB_BytsPerSec - 1) / BPB_BytsPerSec + BPB_FATSz16 * BPB_NumFATs + BPB_RsvdSecCnt` | 未定義 |

### BPB (BIOS Parameter Block) 構造
| 名称 | サイズ [bytes] | 開始アドレス [byte] | 説明 |
|---|:-:|:-:|---|
| BS_JmpBoot | `3` | `0` | ブートコードへのジャンプ命令です。このフィールドは次の2種類のどちらかになります<br/>`0xEB 0x?? 0x90` `0xE9 0x?? 0x??`<br/>`0x??`は任意の8bitsの値で、これはOSを起動するためのブートストラップコードへジャンプする、3bytesのx86の無条件ジャンプ命令です。 ブートストラップコードは通常、セクタ0のBPBより後の残りの部分に入っています(他のセクタの場合もある)。どちらのフォーマットも使えますが、`0xEB 0x?? 0x90`の方がよく使われています。 |
| BS_OEMName | `8` | `3` | これは名前に過ぎません。MicrosoftのOSはこのフィールドはチェックしませんが、チェックするOSも存在します。互換性の問題を最小限に抑えるための設定として、`MSWIN4.1`を推奨します。他の値を設定することも可能ですが、そのボリュームを認識しないFATドライバも存在する可能性があります。通常、このボリュームをフォーマットしたシステムの名称です。 |
| BPB_BytsPerSec | `2` | `11` | セクタあたりのサイズ[bytes]で、`512` `1024` `2048` `4096`のみが使えます。互換性を最大限に保つためには、`512`を使うべきです。このフィールドが`512`であるか否かをチェックせずに、`512`と決め打ちするFATドライバも多数存在するからです。MicrosoftのOSは`1024` `2048` `4096`も正しくサポートします。 <br/>**注意:** 最大の互換性について誤解しないようにしてください。もしメディアに物理セクタサイズNが記録されるのであれば、必ずNを使用する必要があり(但し4096以下でなければならない)、最大の互換性は指定されたセクタサイズのメディアを使用することでのみ達成されます。|
| BPB_SecPerClus | `1` | `13` | アロケーションユニット（クラスタ）あたりのセクタ数です。このフィールドは0以上の2の累乗でなければなりません。 従って、`1` `2` `4` `8` `16` `32` `64` `128`が有効な値ですが、クラスタあたりのバイト数`BPB_BytsPerSec * BPB_SecPerClus`が32KBより大きくなってはいけません。32KB以上でもOKと言う誤解がありますが、32KB以上では正しく動作しません。あるシステムのあるバージョンでは64KB/クラスタを容認しますが、殆どのアプリケーションセットアッププログラムはそのようなFATボリュームでは正しく動作しません。|
| BPB_RsvdSecCnt | `2` | `14` | ボリュームの最初のセクタの初めにある予約領域のセクタ数です。FAT12とFAT16のボリュームにおいては、このフィールドを`0`にすることは出来ず、`1`以外は設定できません。FAT32のボリュームにおいては、通常`32`を設定します。<br/>このフィールドが`1`か否かをチェックセずに予約領域を`1`と決め打ちするFATドライバも多く存在します。MicrosoftのOSは`0`以外の値を正しくサポートします。 |
| BPB_NumFATs | `1` | `16` | このボリューム上のFAT数です。このフィールドは`2`にするべきです。`1`以上の値も完全に正しいですが、いくつかのOSのFATドライバはこのフィールドが2外の場合、正しく動作せず、多くのソフトウェア上の問題を起こすかもしれないからです。MicosoftのFATドライバは2以外の値もサポートしますが、`2`以外の値を使わないことを強く推奨します。<br/>標準値が`2`である理由は、片方のFATのあるセクタが壊れた場合に、重複させることでデータが消える事が無いよう、FATの冗長性を提供するためです。冗長化が意味をなさないフラッシュメモリのようなディスク以外のメディアの場合、2つめのFATに使われるスペースを節約するために`1`に出来ますが、いくつかのFATドライバはそのようなボリュームを正しく認識しないかもしれません。 |
| BPB_RootEntCnt | `2` | `17` | FAT12及びFAT16のボリュームの場合、ルートディレクトリの32バイトのディレクトリ登録数が入ります。FAT32の場合、`0`をセットしなければなりません。FAT12及びFAT16のボリュームの場合、この値に32を乗じた値が`BPB_BytsPerSec`の偶数倍となるべきです。最大の互換性のために、FAT16ボリュームの場合、このフィールドには`512`を使用すべきです。 |
| BPB_TotSec16 | `2` | `19` | これはボリューム上の全ての4領域のすべてのセクタの合計数(16bits)です。このフィールドが`0`の場合、BPB_TotSec32は`0`以外でなければなりません。FAT32ボリュームの場合、このフィールドは`0`でなければなりません。FAT12及びFAT16のボリュームの場合、このフィールドがセクタ数を示し、セクタの合計数が収まる(0x10000より小さい)場合、BPB_TotSec32は`0`となります。|
| BPB_Media | `1` | `21` | リムーバブルではないメディアの場合、`0xF8`が標準値です。リムーバブルメディアの場合は`0xF0`がよく使われています。このフィールドに有効な値は`0xF0` `0xF8` `0xF9` `0xFA` `0xFB` `0xFC` `0xFD` `0xFE` `0xFF`です。他の重要なポイントはここに入力された値はFAT[0]エントリの下位8bitsにも入力されなければならないという事だけです。これは前述(_訳注: 前述の文はまだ訳していません_)のように古いMS-DOS 1.xのメディア決定方法に遡り(_訳注: 多分、互換性の維持のためと言うこと_)、通常、既に使われていません。 |
| BPB_FATSz16 | `2` | `22` | このフィールドはFAT12/FAT16の**1FAT**が専有するセクタ数(16bits)です(_訳注: ONE FATと強調されているので、冗長化の為に2FAT以上使う場合でも、1FAT分のセクタ数だと言うことを強調したいと思われる_)。 FAT32ボリュームではこのフィールドは`0`にしなければならず、BPB_FATSz32がFATセクタ数となります。|
| BPB_SecPerTrk | `2` | `24` | 0x13割込みの為のトラックあたりのセクタ数です。このフィールドは配列(複数のヘッダおよびシリンダでトラックに分割されたボリューム)を持ったメディアにのみ関係し、0x13割込みで見えます。 |
| BPB_NumHeads | `2` | `26` | 0x13割込みの為のヘッド数です。このフィールドはBPB_SecPerTrkと同じで、ジオメトリを持つメディアにのみ関係します。このフィールドはヘッドの数を示します。たとえば、1.44MB 3.5インチフロッピーディスクドライブではこの値は2になります。 |
| BPB_HiddSec | `4` | `28` | このFATボリュームを含むパーティションの前に隠されたセクタ数です。このフィールドは一般的に0x13割込みで見えるメディアにのみ関係します。パーティションが無いメディアの場合、このフィールドは`0`にすべきです。どのような値が適切かはOSの仕様に依ります |
| BPB_TotSec32 | `4` | `32` | このフィールドはボリュームのセクタ数(32bits)です。この数はボリューム上の全ての４領域の全てセクタ数を示します。このフィールドが`0`の場合、BPB_TotSec16は`0`以外でなければなりません。FAT32ボリュームでは、このフィールドは`0`以外にしなければなりません。FAT12/FAT16ボリュームでは、BPB_TotSec16が`0`の場合、このフィールドがセクタ数を示します。(セクタ数が0x10000以上の場合) |

#### FAT12 / FAT16の場合の36byte目以降
| 名称 | サイズ [bytes] | 開始アドレス [byte] | 説明 |
|---|:-:|:-:|---|
| BS_DrvNum | `1` | `36` | Int 0x13命令のドライブ番号(例: `0x80`)。このフィールドはMS-DOSのブートストラップをサポートし、INT 0x13命令のメディアのドライブ番号にセットされます。(`0x00`がフロッピーディスク、`0x80`がハードディスク)<br/>**注意:** このフィールドは実際にはOSの仕様に依ります。 |
| BS_Reserved1 | `1` | `37` | 予約済(Windows NTによって使用される)。FATボリュームを初期化するコードは必ずこのバイトに0をセットすべきです。 |
| BS_BootSig | `1` | `38` | ブートセクタに次の3フィールドが存在することを示す拡張ブートシグネチャ(0x29)バイトです。 |
| BS_VolID | `4` | `39` | ボリュームのシリアルナンバーです。このフィールドはBS_VolLabと共に、リムーバブルメディアのトラッキングをサポートします。これらの値はFATシステムドライバが間違ったディスクがリムーバブルドライブに挿入されたことを検知することを容認します。このIDは通常、単純に現在の日時を結合した32bitsの値として生成されます。 |
| BS_VolLab | `11` | `43` | ボリュームラベルです。このフィールドはルートディレクトリに記録された11bytsのボリュームラベルと一致します。<br/>**注意:** FATドライバはルートディレクトリが持っているボリュームの名前の変更や作成を確認し、このフィールドをアップデートするべきです。ボリューム名が設定されていない時、このフィールドは`NO NAME`が設定されます。 |
| BS_FilSysType | `8` | `54` | `FAT12` `FAT16` `FAT`のいずれかの文字列です。<br/>沢山の人がこのフィールドの文字列が、ボリュームの持つFATタイプがFAT12, FAT16, FAT32のいずれであるかを決定するために使われていると考えていますが、正しくありません。このフィールドは実際、BPBの一部ではないことからも分かります。この文字列はただの情報で、しばしば正しくセットされていなかったり、入っていなかったりするため、MicrosoftのファイルシステムドライバがFATタイプを決定するのには使用されていません。このドキュメントのFATタイプの決定方法の項を参照してください。幾つかのMicrosoft以外のFATドライバはこの文字列を見るので、FATタイプに基づいて設定すべきです。 |
| ブートストラップコード | `448` | `62` | 使わなかった領域は`0`で埋める |


#### 510byte目以降
| 名称 | サイズ [bytes] | 開始アドレス [byte] | 説明 |
|---|:-:|:-:|---|
| ブートシグネチャ | `2` | `510` | `0xAA55`でなければならない<br/>**注意:** 多くのFATドキュメントが間違って0xAA55シグネチャは「ブートセクタの最後の2バイトに設置する」と書かれている。このやり方は、BPB_BytsPerSecが512の場合にのみ正しいです。BPB_BytsPerSecが512より大きい場合にはこれらのシグネチャのアドレスは変更されません(_訳注: すなわちいつも510-511byteに置くべきという事_)が、ブートセクタの最後の2バイトにもこのシグネチャを置くことは全然問題ありません。 |
| - | `BS_BytsPerSec - 512` | `512` | セクタの残りは`0`で埋める |
